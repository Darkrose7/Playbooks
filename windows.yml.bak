---
- name: Playbook 4 - Konfiguracja Windows Server
  hosts: windows
  gather_facts: no
  vars:
    nazwisko: "Gajda" 
    pool_name: "adg_pool"
    vdisk_name: "adg_vdisk"
    drive_letter: "F"
    share_path: "F:\\Projekty"
    share_name: "Projekty_{{ nazwisko }}"
    group_name: "Kierownicy_{{ nazwisko }}"

  tasks:
    - name: Utwórz Pulę Dyskową, Dysk Wirtualny (Mirror) i sformatuj jako ReFS
      ansible.windows.win_shell: |
        if (-not (Test-Path "{{ drive_letter }}:")) {
            
            $physDisks = Get-PhysicalDisk | Where-Object { $_.CanPool -eq $true }
            
            if ($physDisks.Count -lt 1) {
                Write-Error "Nie znaleziono dysków do utworzenia puli!"
                exit 1
            }

            $pool = New-StoragePool -FriendlyName "{{ pool_name }}" -StorageSubsystemFriendlyName "Windows Storage*" -PhysicalDisks $physDisks
            
            New-VirtualDisk -StoragePoolFriendlyName "{{ pool_name }}" `
                            -FriendlyName "{{ vdisk_name }}" `
                            -ResiliencySettingName Mirror `
                            -UseMaximumSize `
                            -ProvisioningType Fixed

            $disk = Get-VirtualDisk -FriendlyName "{{ vdisk_name }}" | Get-Disk
            
            Initialize-Disk -Number $disk.Number -PartitionStyle GPT
            New-Partition -DiskNumber $disk.Number -DriveLetter "{{ drive_letter }}" -UseMaximumSize
            Format-Volume -DriveLetter "{{ drive_letter }}" -FileSystem ReFS -Confirm:$false -Force
        }
      args:
        creates: "{{ drive_letter }}:\\"

    - name: Utwórz grupę zabezpieczeń Kierownicy
      ansible.windows.win_group:
        name: "{{ group_name }}"
        state: present
        description: "Grupa dla kierowników projektów"

    - name: Utwórz użytkownika Marek Romanek
      ansible.windows.win_user:
        name: "Marek Romanek"
        password: "Password123!" 
        state: present
        groups:
          - "{{ group_name }}"
          - Użytkownicy

    - name: Utwórz użytkownika Jacek Gula
      ansible.windows.win_user:
        name: "Jacek Gula"
        password: "Password123!"  
        state: present
        groups:
          - "{{ group_name }}"
          - Użytkownicy

    - name: Utwórz katalog Projekty na dysku F
      ansible.windows.win_file:
        path: "{{ share_path }}"
        state: directory

    - name: Ustaw uprawnienia NTFS
      ansible.windows.win_acl:
        path: "{{ share_path }}"
        inheritance_flags: ContainerInherit,ObjectInherit
        propagation_flags: None
        state: present
        type: allow
        user: "{{ item }}"
        rights: FullControl
      loop:
        - Administratorzy
        - "{{ group_name }}"

    - name: Usuń grupę Użytkownicy z ACL katalogu
      ansible.windows.win_shell: icacls "{{ share_path }}" /remove "Użytkownicy"

    - name: Utwórz Udział Sieciowy
      ansible.windows.win_share:
        name: "{{ share_name }}"
        path: "{{ share_path }}"
        list: yes
        full: "Administratorzy,{{ group_name }}"
        read: ""  
        change: ""

    - name: Zainstaluj Chocolatey (Bootstrap)
      chocolatey.chocolatey.win_chocolatey:
        name: chocolatey
        state: present
      ignore_errors: yes

    - name: Zresetuj połączenie (Odśwież PATH)
      meta: reset_connection

    - name: Zainstaluj aplikacje narzędziowe
      chocolatey.chocolatey.win_chocolatey:
        name: "{{ item }}"
        state: present
      loop:
        - 7zip
        - bind-toolsonly  
        - firefox
      environment:
        Path: "C:\\ProgramData\\chocolatey\\bin;C:\\Windows\\system32;C:\\Windows;C:\\Windows\\System32\\Wbem;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\"

    - name: Zablokuj usuwanie drukarek (Polityka HKLM)
      ansible.windows.win_regedit:
        path: HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer
        name: NoDeletePrinter
        data: 1
        type: dword
        state: present
